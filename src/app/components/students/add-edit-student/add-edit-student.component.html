<div class="container-fluid py-4 add-edit-student-container">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title">
            <i class="fas fa-user-edit me-3"></i>
            {{ isEditMode ? 'Edit Student Profile' : 'Add New Student' }}
        </h2>
        <a [routerLink]="['/students']" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Roster
        </a>
    </div>

    @if (loading) {
        <div class="text-center py-5">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2">Loading student details...</p>
        </div>
    }

    @if (errorMessage && !loading) {
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>{{ errorMessage }}
        </div>
    }

    @if (successMessage) {
        <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
        </div>
    }

    @if (!loading) {
        <form [formGroup]="studentForm" (ngSubmit)="onSubmit()" class="bg-white p-4 rounded shadow-sm">
            <h5 class="mb-3 text-primary">{{ isEditMode ? 'Profile Details' : 'New Enrollment Details' }}</h5>
            <hr>

            <div class="row g-3">

                <div class="col-md-6">
                    <label for="studentId" class="form-label required">Student ID</label>
                    <input id="studentId" type="text" formControlName="studentId" class="form-control"
                           [ngClass]="{ 'is-invalid': (f['studentId'].touched || submitting) && f['studentId'].invalid }">
                    @if ((f['studentId'].touched || submitting) && f['studentId'].errors) {
                        <div class="invalid-feedback">Student ID is required.</div>
                    }
                </div>

                <div class="col-md-6">
                    <label for="email" class="form-label required">Email</label>
                    <input id="email" type="email" formControlName="email" class="form-control"
                           [ngClass]="{ 'is-invalid': (f['email'].touched || submitting) && f['email'].invalid }">
                    @if ((f['email'].touched || submitting) && f['email'].errors) {
                        <div class="invalid-feedback">A valid email is required.</div>
                    }
                </div>

                <div class="col-md-6">
                    <label for="firstName" class="form-label required">First Name</label>
                    <input id="firstName" type="text" formControlName="firstName" class="form-control"
                           [ngClass]="{ 'is-invalid': (f['firstName'].touched || submitting) && f['firstName'].invalid }">
                    @if ((f['firstName'].touched || submitting) && f['firstName'].errors) {
                        <div class="invalid-feedback">First name is required.</div>
                    }
                </div>

                <div class="col-md-6">
                    <label for="lastName" class="form-label required">Last Name</label>
                    <input id="lastName" type="text" formControlName="lastName" class="form-control"
                           [ngClass]="{ 'is-invalid': (f['lastName'].touched || submitting) && f['lastName'].invalid }">
                    @if ((f['lastName'].touched || submitting) && f['lastName'].errors) {
                        <div class="invalid-feedback">Last name is required.</div>
                    }
                </div>

                <div class="col-md-6">
                    <label for="phone" class="form-label">Phone</label>
                    <input id="phone" type="text" formControlName="phone" class="form-control">
                </div>

                @if (!isEditMode) {
                    <div class="col-md-6">
                        <label for="password" class="form-label required">Password</label>
                        <input id="password" type="password" formControlName="password" class="form-control"
                               [ngClass]="{ 'is-invalid': (f['password'].touched || submitting) && f['password'].invalid }">
                        @if ((f['password'].touched || submitting) && f['password'].errors) {
                            <div class="invalid-feedback">
                                @if (f['password'].errors['required']) {
                                    <div>Password is required.</div>
                                }
                                @if (f['password'].errors['minlength']) {
                                    <div>Password must be at least 6 characters.</div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>

            <h5 class="mt-4 mb-3 text-primary">Academic Details</h5>
            <hr>

            <div class="row g-3">
                <div class="col-md-4">
                    <label for="currentClass" class="form-label required">Current Class</label>
                    <select id="currentClass" formControlName="currentClass" class="form-select"
                            [ngClass]="{ 'is-invalid': (f['currentClass'].touched || submitting) && f['currentClass'].invalid }">
                        <option value="">Select Class</option>
                        @for (cls of classes; track cls) {
                            <option [value]="cls">{{ cls }}</option>
                        }
                    </select>
                    @if ((f['currentClass'].touched || submitting) && f['currentClass'].invalid) {
                        <div class="invalid-feedback">Current Class is required.</div>
                    }
                </div>

                <div class="col-md-4">
                    <label for="enrollmentDate" class="form-label required">Enrollment Date</label>
                    <input id="enrollmentDate" type="date" formControlName="enrollmentDate" class="form-control"
                           [ngClass]="{ 'is-invalid': (f['enrollmentDate'].touched || submitting) && f['enrollmentDate'].invalid }">
                    @if ((f['enrollmentDate'].touched || submitting) && f['enrollmentDate'].invalid) {
                        <div class="invalid-feedback">Enrollment Date is required.</div>
                    }
                </div>

                <div class="col-md-4">
                    <label for="status" class="form-label required">Status</label>
                    <select id="status" formControlName="status" class="form-select"
                            [ngClass]="{ 'is-invalid': (f['status'].touched || submitting) && f['status'].invalid }">
                        <option value="">Select Status</option>
                        @for (status of studentStatuses; track status) {
                            <option [value]="status">{{ status }}</option>
                        }
                    </select>
                    @if ((f['status'].touched || submitting) && f['status'].invalid) {
                        <div class="invalid-feedback">Status is required.</div>
                    }
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                <button type="submit" class="btn btn-success me-2" [disabled]="submitting || studentForm.invalid">
                    @if (submitting) {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    <i class="fas fa-save me-2"></i>
                    {{ isEditMode ? 'Update Profile' : 'Save New Student' }}
                </button>
                <button type="button" class="btn btn-outline-danger" [routerLink]="['/students']" [disabled]="submitting">Cancel</button>
            </div>
        </form>
    }
</div>
